# Next Session Tasks - Z-Machine Compiler

## Major Success This Session 🎉

**BREAKTHROUGH**: Fixed PC calculation inconsistency causing bytecode corruption
- **Before**: 27 passing / 14 failing tests  
- **After**: 31 passing / 6 failing tests
- **Impact**: +8 additional tests now passing

### Root Cause Fixed
- PC calculation was inconsistent between preview (line 885) and final (line 1009)
- Early calculation used correct `init_routine_locals_count` but final used hardcoded 1-byte
- Fixed logic: No init block → PC points to function header directly
- Fixed logic: With init block → PC points after init routine header

## Remaining Work for Next Session

### 6 Failing Tests (Categorized by Error Type)

#### 1. Execution Flow Issues (4 tests) - **HIGHEST PRIORITY**
- `test_array_compilation.z3` - Invalid opcode 0x00 at 0x0365
- `test_array_errors.z3` - Invalid opcode 0x00 at 0x034b  
- `test_array_ops.z3` - Invalid opcode 0x00 at 0x03d3
- `test_random.z3` - Invalid opcode 0x00 at 0x03e2

**Note**: These are NOT PC calculation issues (that's fixed). These are execution flow problems during runtime - something jumps to wrong addresses during execution.

**Investigation Approach**:
1. Check if these tests use complex control flow (loops, function calls, branches)
2. Debug execution trace to see where the jump to invalid address happens
3. Likely issues: branch offset calculation, function call address resolution, or loop jump targets

#### 2. Instruction Operand Issues (1 test)
- `test_property_simple.z3` - "sread requires at least 2 operands"

**Investigation Approach**:
1. Check how `sread` instruction is being generated
2. Verify operand count in instruction emission
3. May be related to input/parsing instruction generation

#### 3. Memory Bounds Issues (1 test)  
- `test_variables.z3` - "Branch to address 0x0452 is outside memory bounds (866)"

**Investigation Approach**:
1. Check branch offset calculation 
2. Verify memory allocation sizes
3. May be related to reference resolution or memory layout

## Recommended Next Session Approach

### Phase 1: Quick Wins (15-30 minutes)
1. **Test the sread issue** - likely simple operand count fix
2. **Test the memory bounds issue** - may be simple memory size calculation

### Phase 2: Main Investigation (60-90 minutes) 
1. **Focus on execution flow issues** (affects 4 tests = highest impact)
2. **Debug approach**:
   - Run with detailed execution tracing
   - Identify where execution jumps to invalid addresses
   - Check: branch instructions, function calls, loop constructs
   - Fix the underlying instruction generation bug

### Expected Outcome
If execution flow issues are resolved, we could potentially reach **35+ passing tests** with only 1-2 edge case failures remaining.

## Key Files Modified This Session
- `src/grue_compiler/codegen.rs` - PC calculation fix (lines 883-1025)
- All test files regenerated with correct PC addresses

## Debug Commands for Next Session
```bash
# Test current status
for file in test_*.z3; do echo -n "Testing $file: "; timeout 3 bash -c "echo '' | RUST_LOG=error cargo run --bin gruesome -- $file" 2>&1 | grep -q -E "(Error|Failed)" && echo "❌ FAILED" || echo "✅ PASSED"; done

# Debug execution flow issues  
RUST_LOG=trace cargo run --bin gruesome -- test_array_compilation.z3 2>&1 | grep -E "(EXEC_INSTR|PC=|jump|branch)"

# Check generated bytecode
xxd -s +0x0365 -l 16 test_array_compilation.z3
```

## Success Metrics
- **Target**: 35+ passing tests (from current 31)
- **Stretch Goal**: 37+ passing tests (resolve all but 1-2 edge cases)