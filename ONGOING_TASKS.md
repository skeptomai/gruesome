# CURRENT PRIORITY: Branch Offset Overflow Fix (October 24, 2025)

## 🎯 ACTIVE TASK: Systematic 2-Byte Branch Conversion with Zero Regression

**STATUS**: Ready to implement phased plan for converting all branches to 2-byte format to eliminate overflow errors

**ROOT CAUSE**: Two-pass compilation mismatch where estimated branch size (1-byte) differs from actual size needed (2-byte), causing compilation failures:
```
Compilation error: Code generation error: 1-byte branch offset 75 out of range (-64 to +63) at location 0x060e
```

**STRATEGIC DECISION**: Convert all branches to 2-byte format for reliability and simplicity, accepting minimal size overhead (1-2% file size increase) to eliminate entire class of overflow bugs.

---

## IMPLEMENTATION PLAN: Six-Phase Conversion with Full Regression Testing

### Phase 1: Establish Baseline and Test Infrastructure ✅ COMPLETED
**Goal**: Create comprehensive tests to detect any regressions

#### Tasks Completed:
1. **✅ Captured current test state**:
   ```bash
   cargo test 2>&1 | tee baseline_tests.log
   ```
   - **Result**: 260 tests captured with 2 failures, 5 ignored
   - **Status**: Baseline established for regression detection

2. **✅ Created branch-specific unit tests** (`branch_offset_overflow_tests.rs`):
   - ✅ Test 1-byte vs 2-byte branch format bits
   - ✅ Test edge cases (offset = -64, -63, 62, 63, 64, 65, 75)
   - ✅ Test ZMachine version compatibility
   - ✅ Test branch offset calculation logic
   - ✅ Test file size impact measurement framework
   - ✅ **14 tests created and passing**

3. **✅ Created compilation verification tests** (`compilation_verification_tests.rs`):
   - ✅ Test compilation detects branch overflow errors (currently failing as expected)
   - ✅ Test generated bytecode has valid Z-Machine format
   - ✅ Test branch format bit consistency
   - ✅ Test multiple Z-Machine version compatibility
   - ✅ Test file size baseline measurement
   - ✅ **7 tests created with 6 passing, 1 expected failure**

4. **✅ Created gameplay regression tests** (`gameplay_regression_tests.rs`):
   - ✅ Test baseline game compilation and file generation
   - ✅ Test interpreter can load baseline game
   - ✅ Test game startup sequence with quit
   - ✅ Test navigation commands (north, south, inventory)
   - ✅ Test object examination (examine mailbox)
   - ✅ Test baseline generation for phase comparison
   - ✅ **6 tests created and all passing**

**✅ Phase 1 Results**:
- **27 new tests created** across 3 test modules
- **Branch overflow error confirmed**: "1-byte branch offset 75 out of range (-64 to +63) at location 0x060e"
- **Test infrastructure complete**: Ready to detect any regressions during conversion
- **Baseline files generated**: `tests/phase1_baseline.z3` for comparison
- **All regression tests passing**: Capture current behavior for validation

### Phase 2: Single Location Change with Full Testing ⭐ NEXT
**Goal**: Change ONE location where offset_size is determined, test thoroughly

**Ready to Execute**: Phase 1 complete, comprehensive test infrastructure in place

#### Target: First occurrence in `codegen_instructions.rs` around line 2020
```rust
// BEFORE:
if offset == -1 {
    1 // Placeholder defaults to 1-byte
} else if offset >= -64 && offset <= 63 {
    1 // Short offsets fit in 1 byte
} else {
    2 // Long offsets need 2 bytes
}

// AFTER:
2 // ALWAYS use 2-byte format for reliability
```

#### Test sequence:
- Run all unit tests (must pass)
- Compile mini_zork.grue (must succeed)
- Run gameplay test (must work)
- Compare bytecode patterns with baseline
- Measure file size increase

**Verification**: Partial improvement without breaking anything

### Phase 3: Complete the Conversion Location by Location
**Goal**: Change remaining locations one at a time with testing between each

1. **Location 2**: Line ~2281 in same file
2. **Location 3**: Line ~2383 in same file
3. **Test after each**: Same test sequence as Phase 2

**Verification**: Progressive improvement, no regressions

### Phase 4: Handle Legacy Branch Creation Paths
**Goal**: Ensure ALL branch creation paths use 2-byte format

1. **Search for remaining 1-byte defaults**:
   ```bash
   grep -r "offset_size.*1" src/grue_compiler/
   grep -r "1.*byte.*branch" src/grue_compiler/
   ```

2. **Update any remaining paths found**
3. **Comprehensive test**: Compile and verify NO 1-byte branches remain

**Verification**: Complete conversion achieved

### Phase 5: Code Cleanup and Optimization
**Goal**: Remove dead code and simplify logic

1. **Remove unused 1-byte branch handling** (carefully, may be needed for edge cases)
2. **Simplify offset_size calculation logic**
3. **Update comments and documentation**
4. **Run full test suite**

**Verification**: Cleaner code, same functionality

### Phase 6: Regression Testing and Validation
**Goal**: Prove the change is safe and beneficial

1. **Compile multiple test games** (not just mini_zork.grue)
2. **Measure file size impact** across all test cases
3. **Performance testing** (if applicable)
4. **Edge case testing** with unusual branch patterns

**Verification**: Ready for production use

---

## TESTING STRATEGY FOR EACH PHASE

### Unit Tests (Critical!)
```bash
# Branch-specific tests
cargo test branch_offset
cargo test deferred_branch
cargo test instruction_emit

# Two-pass compilation tests
cargo test two_pass
cargo test placeholder_resolution
```

### Compilation Tests
```bash
# Basic compilation success
cargo run --bin grue-compiler -- examples/mini_zork.grue -o tests/phase_test.z3

# Multiple test cases
cargo run --bin grue-compiler -- examples/collision_test.grue -o tests/collision_test.z3
```

### Bytecode Validation
```bash
# Structure validation
hexdump -C tests/phase_test.z3 | head -20

# Branch format verification (look for 2-byte branch patterns)
hexdump -C tests/phase_test.z3 | grep -E "(c0|80).{2,4}(ff|[0-9a-f]{2})"
```

### Gameplay Regression Tests
```bash
# Basic interaction test
echo "north\nsouth\ninventory\nquit\ny" | ./target/debug/gruesome tests/phase_test.z3

# Examine command test (original garbled text bug)
echo "examine mailbox\nquit\ny" | ./target/debug/gruesome tests/phase_test.z3
```

### File Size Tracking
```bash
# Monitor size increase per phase
ls -la tests/phase_test.z3
du -h tests/phase_test.z3
```

---

## SAFETY MEASURES

1. **Git commit after each phase** with descriptive messages
2. **Keep baseline binaries** for comparison (`tests/working_game.z3` from 731a)
3. **Document any unexpected behavior** immediately
4. **Ready to revert** if any phase shows problems
5. **No simultaneous changes** - only branch format changes
6. **Comprehensive logging** at debug level for patch tracking

---

## SUCCESS CRITERIA

- ✅ All existing tests continue to pass
- ✅ mini_zork.grue compiles without overflow errors
- ✅ Game plays identically to baseline
- ✅ File size increase < 5%
- ✅ No new runtime errors
- ✅ Bytecode passes Z-Machine validation
- ✅ Unit tests provide regression protection

---

## IMPLEMENTATION NOTES

### Why This Approach is Safe:
1. **Incremental**: One change at a time with full testing
2. **Reversible**: Each phase can be rolled back independently
3. **Measurable**: Concrete metrics at each step
4. **Comprehensive**: Unit tests + integration tests + gameplay tests
5. **Conservative**: Accepts small overhead for major reliability improvement

### Why 2-Byte Conversion is Right:
1. **Eliminates entire bug class**: No more branch overflow errors
2. **Simplifies codebase**: Remove complex size estimation logic
3. **Minimal overhead**: 1-2% size increase in 7KB games is negligible
4. **Future-proof**: Handles any branch distance without issues
5. **Proven reliable**: Many compilers choose larger formats for stability

---

## ✅ PHASE 1 EXECUTION COMPLETE! (October 24, 2025)

**Phase 1 Successfully Completed**: All tasks finished, comprehensive test infrastructure created.

### Phase 1 Summary:
- **✅ 27 new tests created** providing complete regression protection
- **✅ Branch overflow bug confirmed** at specific location 0x060e with offset 75
- **✅ Test infrastructure validates** compilation, bytecode format, and gameplay behavior
- **✅ Baseline captured** with 260 existing tests (2 failures, 5 ignored)
- **✅ Ready for Phase 2** with full safety net for systematic conversion

### Next Action: Execute Phase 2
**Command to start Phase 2**:
```bash
# Navigate to target file and implement first 2-byte conversion
code src/grue_compiler/codegen_instructions.rs +2020
```

**Phase 2 Target**: Single location change in `codegen_instructions.rs` around line 2020

---

# HISTORICAL TASKS (Moved for Reference)

*Previous patch collision and instruction corruption fixes have been moved to `BRANCH_OFFSET_OVERFLOW_FIX.md` for historical reference. These issues were completely resolved in earlier work.*